<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Condomínio - CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/header.css" rel="stylesheet">
    <link href="css/cadastro-condominio.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-container">
            <div class="logo">
                <h1>CRM Condomínio</h1>
            </div>
            <div class="user-menu">
                <img src="src/img/team-3.jpg" alt="Foto do Usuário" class="user-photo">
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        Configurações
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <li><a class="dropdown-item" href="perfil.html">Meu Perfil</a></li>
                        <li><a class="dropdown-item" href="configuracoes.html">Configurações</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutBtn">Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>CRM Condomínio</h3>
            </div>
            <ul class="list-unstyled components">
                <li>
                    <a href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
                </li>
                <li>
                    <a href="lista-condominios.html"><i class="bi bi-building"></i> Condomínios</a>
                </li>
                <li>
                    <a href="lista-moradores.html"><i class="bi bi-people"></i> Moradores</a>
                </li>
                <li>
                    <a href="gestao-boletos.html"><i class="bi bi-receipt"></i> Gestão de Boletos</a>
                </li>
                <li>
                    <a href="gestao-financeira.html"><i class="bi bi-cash-coin"></i> Financeiro</a>
                </li>
                <li>
                    <a href="relatorios.html"><i class="bi bi-graph-up"></i> Relatórios</a>
                </li>
            </ul>
        </nav>

        <!-- Conteúdo -->
        <div id="content">
            <!-- Cabeçalho da página -->
            <div class="cadastro-header text-center">
                <h2><i class="bi bi-building-add"></i> Cadastro de Condomínio</h2>
                <p>Preencha os dados do novo condomínio</p>
            </div>

            <div class="container">
                <!-- Progress Steps -->
                <div class="progress-steps mb-4">
                    <div class="step active" data-step="1">1</div>
                    <div class="step" data-step="2">2</div>
                    <div class="step" data-step="3">3</div>
                </div>

                <!-- Formulário -->
                <div class="row justify-content-center">
                    <div class="col-12 col-lg-8">
                        <div class="cadastro-card">
                            <div class="card-body p-4">
                                <form id="condominioForm" class="needs-validation" novalidate>
                                    <!-- Step 1: Informações Básicas -->
                                    <div class="form-section" id="step1">
                                        <h4 class="mb-4">Informações Básicas</h4>
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="nome" placeholder="Nome do Condomínio" required>
                                            <label for="nome">Nome do Condomínio</label>
                                            <div class="invalid-feedback">
                                                Por favor, informe o nome do condomínio.
                                            </div>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="cnpj" placeholder="CNPJ" required>
                                            <label for="cnpj">CNPJ</label>
                                            <div class="invalid-feedback">
                                                Por favor, informe um CNPJ válido.
                                            </div>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="email" class="form-control" id="email" placeholder="E-mail" required>
                                            <label for="email">E-mail</label>
                                            <div class="invalid-feedback">
                                                Por favor, informe um e-mail válido.
                                            </div>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="tel" class="form-control" id="telefone" placeholder="Telefone" required>
                                            <label for="telefone">Telefone</label>
                                            <div class="invalid-feedback">
                                                Por favor, informe um telefone válido.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 2: Endereço -->
                                    <div class="form-section d-none" id="step2">
                                        <h4 class="mb-4">Endereço</h4>
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="cep" placeholder="CEP" required>
                                            <label for="cep">CEP</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="endereco" placeholder="Endereço" required>
                                            <label for="endereco">Endereço</label>
                                        </div>

                                        <div class="row">
                                            <div class="col-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="numero" placeholder="Número" required>
                                                    <label for="numero">Número</label>
                                                </div>
                                            </div>
                                            <div class="col-8">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="complemento" placeholder="Complemento">
                                                    <label for="complemento">Complemento</label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="bairro" placeholder="Bairro" required>
                                            <label for="bairro">Bairro</label>
                                        </div>

                                        <div class="row">
                                            <div class="col-8">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="cidade" placeholder="Cidade" required>
                                                    <label for="cidade">Cidade</label>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" id="estado" required>
                                                        <option value="">Selecione</option>
                                                        <option value="SP">SP</option>
                                                        <option value="RJ">RJ</option>
                                                        <option value="MG">MG</option>
                                                        <!-- Adicionar outros estados -->
                                                    </select>
                                                    <label for="estado">Estado</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 3: Configurações -->
                                    <div class="form-section d-none" id="step3">
                                        <h4 class="mb-4">Configurações do Condomínio</h4>
                                        <div class="form-floating mb-3">
                                            <input type="number" class="form-control" id="unidades" placeholder="Número de Unidades" required min="1">
                                            <label for="unidades">Número de Unidades</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <select class="form-select" id="tipo" required>
                                                <option value="">Selecione</option>
                                                <option value="residencial">Residencial</option>
                                                <option value="comercial">Comercial</option>
                                                <option value="misto">Misto</option>
                                            </select>
                                            <label for="tipo">Tipo do Condomínio</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="number" class="form-control" id="andares" placeholder="Número de Andares" required min="1">
                                            <label for="andares">Número de Andares</label>
                                        </div>

                                        <div class="form-floating mb-3">
                                            <input type="number" class="form-control" id="blocos" placeholder="Número de Blocos" required min="1">
                                            <label for="blocos">Número de Blocos</label>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Áreas Comuns</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="piscina">
                                                <label class="form-check-label" for="piscina">Piscina</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="academia">
                                                <label class="form-check-label" for="academia">Academia</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="salaoFestas">
                                                <label class="form-check-label" for="salaoFestas">Salão de Festas</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="playground">
                                                <label class="form-check-label" for="playground">Playground</label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botões de navegação -->
                                    <div class="d-flex justify-content-between mt-4">
                                        <button type="button" class="btn btn-light" id="prevBtn" style="display: none;">
                                            <i class="bi bi-arrow-left"></i> Anterior
                                        </button>
                                        <button type="button" class="btn btn-primary" id="nextBtn">
                                            Próximo <i class="bi bi-arrow-right"></i>
                                        </button>
                                        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                                            <i class="bi bi-check-circle"></i> Finalizar Cadastro
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.5/dist/jquery.inputmask.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentStep = 1;
            const form = document.getElementById('condominioForm');
            const steps = document.querySelectorAll('.form-section');
            const progressSteps = document.querySelectorAll('.step');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const submitBtn = document.getElementById('submitBtn');

            // Inicializa máscaras
            const cnpjInput = document.getElementById('cnpj');
            const telefoneInput = document.getElementById('telefone');
            const cepInput = document.getElementById('cep');

            // Aplica máscaras usando vanilla JavaScript
            function maskCNPJ(input) {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 14) {
                        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                        value = value.replace(/(\d{4})(\d)/, '$1-$2');
                    }
                    e.target.value = value;
                });
            }

            function maskPhone(input) {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
                    }
                    e.target.value = value;
                });
            }

            function maskCEP(input) {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 8) {
                        value = value.replace(/^(\d{5})(\d)/, '$1-$2');
                    }
                    e.target.value = value;
                });
            }

            maskCNPJ(cnpjInput);
            maskPhone(telefoneInput);
            maskCEP(cepInput);

            // Função para atualizar os steps
            function updateSteps() {
                steps.forEach((step, index) => {
                    if (index + 1 === currentStep) {
                        step.classList.remove('d-none');
                    } else {
                        step.classList.add('d-none');
                    }
                });

                progressSteps.forEach((step, index) => {
                    if (index + 1 === currentStep) {
                        step.classList.add('active');
                    } else if (index + 1 < currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                // Atualiza os botões
                if (currentStep === 1) {
                    prevBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'block';
                }

                if (currentStep === 3) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = 'block';
                } else {
                    nextBtn.style.display = 'block';
                    submitBtn.style.display = 'none';
                }
            }

            // Event Listeners
            nextBtn.addEventListener('click', () => {
                if (currentStep < 3) {
                    currentStep++;
                    updateSteps();
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 1) {
                    currentStep--;
                    updateSteps();
                }
            });

            // Busca CEP
            cepInput.addEventListener('blur', async () => {
                const cep = cepInput.value.replace(/\D/g, '');
                if (cep.length === 8) {
                    try {
                        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                        const data = await response.json();
                        if (!data.erro) {
                            document.getElementById('endereco').value = data.logradouro;
                            document.getElementById('bairro').value = data.bairro;
                            document.getElementById('cidade').value = data.localidade;
                            document.getElementById('estado').value = data.uf;
                        }
                    } catch (error) {
                        console.error('Erro ao buscar CEP:', error);
                    }
                }
            });

            // Submit do formulário
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!form.checkValidity()) {
                    e.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                try {
                    const formData = new FormData(form);
                    const response = await fetch('/api/condominios', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(Object.fromEntries(formData))
                    });

                    if (response.ok) {
                        alert('Condomínio cadastrado com sucesso!');
                        window.location.href = 'lista-condominios.html';
                    } else {
                        throw new Error('Erro ao cadastrar condomínio');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao cadastrar condomínio. Tente novamente.');
                }
            });

            // Toggle do sidebar
            const sidebarToggle = document.createElement('button');
            sidebarToggle.id = 'sidebarCollapse';
            sidebarToggle.className = 'btn';
            sidebarToggle.innerHTML = '<i class="bi bi-list"></i>';
            document.body.appendChild(sidebarToggle);

            sidebarToggle.addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
        });
    </script>
</body>
</html>